name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: gotodo
          POSTGRES_PASSWORD: gotodo
          POSTGRES_DB: gotodo
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U gotodo -d gotodo"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      PORT: "8081"
      DATABASE_URL: "postgres://gotodo:gotodo@localhost:5432/gotodo?sslmode=disable"

      # Smoke test admin creds (CI only)
      ADMIN_EMAIL: "admin-ci@example.com"
      ADMIN_PASSWORD: "password123"

      # Base URL for smoke test
      BASE_URL: "http://localhost:8081"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Download dependencies
        run: go mod download

      - name: Install migrate
        run: |
          curl -sSL https://github.com/golang-migrate/migrate/releases/download/v4.17.1/migrate.linux-amd64.tar.gz \
            | tar -xz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version

      - name: Apply DB migrations
        run: |
          migrate -path internal/db/migrations -database "$DATABASE_URL" up

      - name: Build
        run: go build ./...

      # Start server in background
      - name: Start API server
        run: |
          nohup go run ./cmd/server > server.log 2>&1 &
          echo "Server PID: $!"
          
          for i in {1..40}; do
            if curl -fsS "$BASE_URL/api/v1/ready" >/dev/null; then
              echo "Server is ready."
              exit 0
            fi
            echo "Waiting for server..."
            sleep 1
          done

          echo "Server did not become ready in time."
          echo "---- server.log ----"
          tail -200 server.log || true
          exit 1

      - name: Run unit tests
        run: go test ./...

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: server.log
docker:
  runs-on: ubuntu-latest
  needs: build

  permissions:
    contents: read
    packages: write

  steps:
    - uses: actions/checkout@v4

    - name: Set lowercase image name
      id: vars
      run: |
        echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log into GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build (and maybe push) Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ github.sha }}

